<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinzX Photobooth | Modern Camera with Live Filters</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Previous CSS remains the same until .camera-container */
        
        .camera-container {
            position: relative;
            width: 100%;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3;
            margin-bottom: 25px;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            display: block;
            filter: none;
            transition: filter 0.3s ease;
        }

        #videoPreviewCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
            pointer-events: none;
            display: none;
        }

        .live-filter-active #videoPreviewCanvas {
            display: block;
        }

        .live-filter-active #videoElement {
            opacity: 0;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 4;
        }

        /* Add new styles for filter preview */
        .filter-preview-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--accent-neon);
            padding: 8px 16px;
            border-radius: var(--radius-full);
            font-size: 0.9rem;
            font-weight: 600;
            display: none;
            z-index: 5;
            animation: slideIn 0.3s ease;
        }

        .live-filter-active .filter-preview-indicator {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(50px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Update effect items */
        .effect-item {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .effect-item:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .effect-item.active {
            border-color: var(--accent-neon);
            box-shadow: 0 0 20px rgba(0, 255, 234, 0.3);
            transform: scale(1.05);
        }

        .effect-item.active::before {
            content: 'üé• LIVE';
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--accent-neon);
            color: var(--bg-dark);
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        /* Update effects grid for more fun filters */
        .effects-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        /* Fun filter categories */
        .filter-category {
            grid-column: 1 / -1;
            font-size: 0.8rem;
            color: var(--accent-pastel);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
            margin-bottom: 8px;
            padding-left: 5px;
            border-left: 3px solid var(--accent-pastel);
        }
    </style>
</head>
<body>
    <!-- Flash Effect Overlay -->
    <div class="flash-overlay" id="flashOverlay"></div>
    
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">üì∏</span>
                <span>FinzX Photobooth</span>
            </div>
            <div class="camera-status">
                <span class="status-indicator"></span>
                <span id="cameraStatus">Kamera siap ‚Ä¢ Filter Live Aktif</span>
            </div>
        </header>
        
        <!-- Main Camera Section -->
        <main class="camera-section">
            <div class="camera-container" id="cameraContainer">
                <video id="videoElement" autoplay playsinline></video>
                <canvas id="videoPreviewCanvas"></canvas>
                <div class="filter-preview-indicator">üé¨ Filter Live Aktif</div>
                <div class="camera-overlay">
                    <div class="overlay-grid">
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                    </div>
                    <div class="focus-center"></div>
                </div>
            </div>
            
            <div class="capture-controls">
                <button class="capture-btn" id="captureBtn" title="Ambil foto"></button>
                
                <div class="ratio-selector">
                    <button class="ratio-btn active" data-ratio="1:1">1:1</button>
                    <button class="ratio-btn" data-ratio="3:4">3:4</button>
                    <button class="ratio-btn" data-ratio="9:16">9:16</button>
                </div>
            </div>
        </main>
        
        <!-- Sidebar Controls -->
        <aside class="sidebar">
            <!-- Effects Panel -->
            <div class="controls-panel">
                <h3 class="panel-title">üé≠ Filter Lucu & Keren</h3>
                
                <div class="effects-grid" id="effectsGrid">
                    <div class="filter-category">Filter Wajah Lucu</div>
                    <!-- Effects will be added by JavaScript -->
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Kekuatan Filter</span>
                        <span id="intensityValue">50%</span>
                    </div>
                    <input type="range" min="0" max="100" value="50" class="slider" id="intensitySlider">
                </div>
            </div>
            
            <!-- Preview Panel -->
            <div class="preview-panel" id="previewPanel">
                <h3 class="preview-title">üñºÔ∏è Pratinjau Foto</h3>
                
                <div class="preview-container">
                    <canvas id="previewCanvas"></canvas>
                    <div class="preview-watermark">design by finzx</div>
                </div>
                
                <div class="preview-controls">
                    <button class="preview-btn download-btn" id="downloadBtn">
                        <span>‚¨áÔ∏è</span> Download HD
                    </button>
                    <button class="preview-btn retake-btn" id="retakeBtn">
                        <span>‚Üª</span> Ambil Ulang
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Footer -->
        <footer class="footer">
            <p>¬© 2024 <span class="footer-highlight">FinzX Photobooth</span> ‚Äî Live Filter Camera Experience</p>
            <p>Lihat efek langsung di kamera sebelum mengambil foto! ‚ú®</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const videoElement = document.getElementById('videoElement');
        const videoPreviewCanvas = document.getElementById('videoPreviewCanvas');
        const videoPreviewCtx = videoPreviewCanvas.getContext('2d');
        const captureBtn = document.getElementById('captureBtn');
        const flashOverlay = document.getElementById('flashOverlay');
        const previewPanel = document.getElementById('previewPanel');
        const previewCanvas = document.getElementById('previewCanvas');
        const downloadBtn = document.getElementById('downloadBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const intensitySlider = document.getElementById('intensitySlider');
        const intensityValue = document.getElementById('intensityValue');
        const cameraStatus = document.getElementById('cameraStatus');
        const effectsGrid = document.getElementById('effectsGrid');
        const ratioButtons = document.querySelectorAll('.ratio-btn');
        const cameraContainer = document.getElementById('cameraContainer');
        
        // State Variables
        let currentStream = null;
        let activeEffects = new Set();
        let currentAspectRatio = '1:1';
        let capturedImage = null;
        let previewContext = null;
        let animationFrameId = null;
        let currentLiveFilter = null;
        
        // Define fun filters with live preview capability
        const effects = [
            // Funny Face Filters
            {
                id: 'catface',
                name: 'Kucing Imut',
                description: 'Kumis dan telinga kucing',
                icon: 'üê±',
                category: 'Filter Wajah Lucu',
                applyEffect: applyCatFaceEffect,
                livePreview: true
            },
            {
                id: 'dogface',
                name: 'Anjing Lucu',
                description: 'Telinga dan hidung anjing',
                icon: 'üê∂',
                category: 'Filter Wajah Lucu',
                applyEffect: applyDogFaceEffect,
                livePreview: true
            },
            {
                id: 'glasses',
                name: 'Keren Pakai Kaca',
                description: 'Kacamata stylish',
                icon: 'üòé',
                category: 'Filter Wajah Lucu',
                applyEffect: applyGlassesEffect,
                livePreview: true
            },
            {
                id: 'clown',
                name: 'Badut Lucu',
                description: 'Hidung merah badut',
                icon: 'ü§°',
                category: 'Filter Wajah Lucu',
                applyEffect: applyClownEffect,
                livePreview: true
            },
            
            // Color & Style Filters
            {
                id: 'rainbow',
                name: 'Pelangi',
                description: 'Warna pelangi cerah',
                icon: 'üåà',
                category: 'Filter Warna',
                applyEffect: applyRainbowEffect,
                livePreview: true
            },
            {
                id: 'disco',
                name: 'Disko',
                description: 'Lampu disko berwarna',
                icon: 'üíÉ',
                category: 'Filter Warna',
                applyEffect: applyDiscoEffect,
                livePreview: true
            },
            {
                id: 'neon',
                name: 'Neon Glow',
                description: 'Cahaya neon menyala',
                icon: 'üîÆ',
                category: 'Filter Warna',
                applyEffect: applyNeonEffect,
                livePreview: true
            },
            {
                id: 'pixel',
                name: 'Pixel Art',
                description: 'Efek game retro',
                icon: 'üëæ',
                category: 'Filter Keren',
                applyEffect: applyPixelEffect,
                livePreview: true
            },
            {
                id: 'comic',
                name: 'Buku Komik',
                description: 'Seperti superhero',
                icon: 'ü¶∏',
                category: 'Filter Keren',
                applyEffect: applyComicEffect,
                livePreview: true
            },
            {
                id: 'vintage',
                name: 'Vintage',
                description: 'Foto jadul tahun 80an',
                icon: 'üìª',
                category: 'Filter Keren',
                applyEffect: applyVintageEffect,
                livePreview: true
            },
            {
                id: 'mirror',
                name: 'Efek Cermin',
                description: 'Pecahan cermin lucu',
                icon: 'ü™û',
                category: 'Filter Keren',
                applyEffect: applyMirrorEffect,
                livePreview: true
            },
            {
                id: 'heart',
                name: 'Love Heart',
                description: 'Hati dan percikan cinta',
                icon: 'üíñ',
                category: 'Filter Lucu',
                applyEffect: applyHeartEffect,
                livePreview: true
            }
        ];

        // Initialize camera
        async function initCamera() {
            try {
                cameraStatus.textContent = 'Mengakses kamera...';
                
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user',
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = currentStream;
                
                // Set canvas size to match video
                videoElement.onloadedmetadata = () => {
                    videoPreviewCanvas.width = videoElement.videoWidth;
                    videoPreviewCanvas.height = videoElement.videoHeight;
                    previewCanvas.width = videoElement.videoWidth;
                    previewCanvas.height = videoElement.videoHeight;
                };
                
                cameraStatus.textContent = 'Kamera aktif ‚Ä¢ Filter Live Ready';
                
                // Initialize preview canvas context
                previewContext = previewCanvas.getContext('2d');
                
                // Start live preview rendering
                startLivePreview();
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                cameraStatus.textContent = 'Kamera tidak tersedia';
                cameraStatus.style.color = '#ff4444';
                
                alert('Tidak dapat mengakses kamera. Pastikan kamera terhubung dan izin diberikan.');
            }
        }

        // Start live preview rendering
        function startLivePreview() {
            function renderLivePreview() {
                if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                    // Set canvas size
                    if (videoPreviewCanvas.width !== videoElement.videoWidth ||
                        videoPreviewCanvas.height !== videoElement.videoHeight) {
                        videoPreviewCanvas.width = videoElement.videoWidth;
                        videoPreviewCanvas.height = videoElement.videoHeight;
                    }
                    
                    // Clear canvas
                    videoPreviewCtx.clearRect(0, 0, videoPreviewCanvas.width, videoPreviewCanvas.height);
                    
                    // Draw video frame (mirrored)
                    videoPreviewCtx.save();
                    videoPreviewCtx.translate(videoPreviewCanvas.width, 0);
                    videoPreviewCtx.scale(-1, 1);
                    videoPreviewCtx.drawImage(videoElement, 0, 0, videoPreviewCanvas.width, videoPreviewCanvas.height);
                    videoPreviewCtx.restore();
                    
                    // Apply live filter if active
                    if (currentLiveFilter) {
                        const effect = effects.find(e => e.id === currentLiveFilter);
                        if (effect && effect.applyEffect) {
                            const intensity = parseInt(intensitySlider.value) / 100;
                            effect.applyEffect(videoPreviewCtx, videoPreviewCanvas.width, videoPreviewCanvas.height, intensity);
                        }
                    }
                }
                
                animationFrameId = requestAnimationFrame(renderLivePreview);
            }
            
            renderLivePreview();
        }

        // Create effect buttons with categories
        function createEffectButtons() {
            const categories = [...new Set(effects.map(e => e.category))];
            
            categories.forEach(category => {
                // Add category header
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'filter-category';
                categoryHeader.textContent = category;
                effectsGrid.appendChild(categoryHeader);
                
                // Add effects for this category
                effects
                    .filter(effect => effect.category === category)
                    .forEach(effect => {
                        const effectElement = document.createElement('div');
                        effectElement.className = 'effect-item';
                        effectElement.dataset.id = effect.id;
                        effectElement.innerHTML = `
                            <div class="effect-icon">${effect.icon}</div>
                            <div class="effect-name">${effect.name}</div>
                            <div class="effect-desc">${effect.description}</div>
                            <div class="effect-badge"></div>
                        `;
                        
                        effectElement.addEventListener('click', () => {
                            // Toggle active state
                            const isActive = effectElement.classList.contains('active');
                            
                            // Remove active from all effects
                            document.querySelectorAll('.effect-item').forEach(el => {
                                el.classList.remove('active');
                            });
                            
                            // Toggle live preview
                            if (!isActive) {
                                effectElement.classList.add('active');
                                currentLiveFilter = effect.id;
                                cameraContainer.classList.add('live-filter-active');
                            } else {
                                currentLiveFilter = null;
                                cameraContainer.classList.remove('live-filter-active');
                            }
                            
                            // Add to active effects for photo capture
                            if (!isActive) {
                                activeEffects.add(effect.id);
                            } else {
                                activeEffects.delete(effect.id);
                            }
                        });
                        
                        effectsGrid.appendChild(effectElement);
                    });
            });
        }

        // Fun filter effect functions
        function applyCatFaceEffect(ctx, width, height, intensity) {
            // Draw cat ears
            const earSize = 80 * intensity;
            const earColor = '#FFB6C1'; // Light pink
            
            // Left ear
            ctx.fillStyle = earColor;
            ctx.beginPath();
            ctx.moveTo(width * 0.4, height * 0.2);
            ctx.lineTo(width * 0.35, height * 0.1);
            ctx.lineTo(width * 0.45, height * 0.15);
            ctx.closePath();
            ctx.fill();
            
            // Right ear
            ctx.beginPath();
            ctx.moveTo(width * 0.6, height * 0.2);
            ctx.lineTo(width * 0.65, height * 0.1);
            ctx.lineTo(width * 0.55, height * 0.15);
            ctx.closePath();
            ctx.fill();
            
            // Draw cat whiskers
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2 * intensity;
            
            // Left whiskers
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(width * 0.4, height * 0.45);
                ctx.lineTo(width * 0.3 - i * 10, height * 0.4 + i * 10);
                ctx.stroke();
            }
            
            // Right whiskers
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(width * 0.6, height * 0.45);
                ctx.lineTo(width * 0.7 + i * 10, height * 0.4 + i * 10);
                ctx.stroke();
            }
            
            // Draw cat nose
            ctx.fillStyle = 'pink';
            ctx.beginPath();
            ctx.arc(width * 0.5, height * 0.45, 10 * intensity, 0, Math.PI * 2);
            ctx.fill();
        }

        function applyDogFaceEffect(ctx, width, height, intensity) {
            // Draw dog ears (floppy)
            const earColor = '#8B4513'; // Saddle brown
            
            // Left ear
            ctx.fillStyle = earColor;
            ctx.beginPath();
            ctx.ellipse(width * 0.35, height * 0.3, 40 * intensity, 60 * intensity, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Right ear
            ctx.beginPath();
            ctx.ellipse(width * 0.65, height * 0.3, 40 * intensity, 60 * intensity, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw dog nose
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.ellipse(width * 0.5, height * 0.5, 25 * intensity, 15 * intensity, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw tongue
            ctx.fillStyle = '#FF69B4';
            ctx.beginPath();
            ctx.ellipse(width * 0.5, height * 0.6, 20 * intensity, 30 * intensity, Math.PI, 0, Math.PI);
            ctx.fill();
        }

        function applyGlassesEffect(ctx, width, height, intensity) {
            // Draw glasses frame
            ctx.strokeStyle = '#FFD700'; // Gold
            ctx.lineWidth = 8 * intensity;
            
            // Left lens
            ctx.beginPath();
            ctx.arc(width * 0.4, height * 0.45, 50 * intensity, 0, Math.PI * 2);
            ctx.stroke();
            
            // Right lens
            ctx.beginPath();
            ctx.arc(width * 0.6, height * 0.45, 50 * intensity, 0, Math.PI * 2);
            ctx.stroke();
            
            // Bridge
            ctx.beginPath();
            ctx.moveTo(width * 0.45, height * 0.45);
            ctx.lineTo(width * 0.55, height * 0.45);
            ctx.stroke();
            
            // Add shine effect
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath();
            ctx.arc(width * 0.45, height * 0.4, 15 * intensity, 0, Math.PI * 2);
            ctx.fill();
        }

        function applyClownEffect(ctx, width, height, intensity) {
            // Draw red clown nose
            ctx.fillStyle = '#FF0000';
            ctx.beginPath();
            ctx.arc(width * 0.5, height * 0.4, 30 * intensity, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw clown hat
            ctx.fillStyle = '#9370DB';
            ctx.beginPath();
            ctx.moveTo(width * 0.4, height * 0.15);
            ctx.lineTo(width * 0.6, height * 0.15);
            ctx.lineTo(width * 0.5, height * 0.05);
            ctx.closePath();
            ctx.fill();
            
            // Draw colorful dots on face
            const colors = ['#FF69B4', '#00FFFF', '#00FF00', '#FFFF00'];
            for (let i = 0; i < 6; i++) {
                ctx.fillStyle = colors[i % colors.length];
                const x = width * (0.3 + Math.random() * 0.4);
                const y = height * (0.5 + Math.random() * 0.3);
                const radius = 10 + Math.random() * 15 * intensity;
                
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function applyRainbowEffect(ctx, width, height, intensity) {
            // Create rainbow gradient overlay
            const gradient = ctx.createLinearGradient(0, 0, width, 0);
            gradient.addColorStop(0, 'rgba(255, 0, 0, 0.3)');     // Red
            gradient.addColorStop(0.2, 'rgba(255, 165, 0, 0.3)'); // Orange
            gradient.addColorStop(0.4, 'rgba(255, 255, 0, 0.3)'); // Yellow
            gradient.addColorStop(0.6, 'rgba(0, 255, 0, 0.3)');   // Green
            gradient.addColorStop(0.8, 'rgba(0, 0, 255, 0.3)');   // Blue
            gradient.addColorStop(1, 'rgba(148, 0, 211, 0.3)');   // Violet
            
            ctx.fillStyle = gradient;
            ctx.globalCompositeOperation = 'overlay';
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
            
            // Add rainbow sparkles
            for (let i = 0; i < 20 * intensity; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const radius = 3 + Math.random() * 7;
                const color = `hsl(${Math.random() * 360}, 100%, 70%)`;
                
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function applyDiscoEffect(ctx, width, height, intensity) {
            // Apply color cycling
            const time = Date.now() / 1000;
            const hue = (time * 180) % 360;
            
            // Colorful disco overlay
            const gradient = ctx.createRadialGradient(
                width / 2, height / 2, 0,
                width / 2, height / 2, Math.max(width, height) / 2
            );
            gradient.addColorStop(0, `hsla(${hue}, 100%, 50%, ${0.3 * intensity})`);
            gradient.addColorStop(0.5, `hsla(${(hue + 120) % 360}, 100%, 50%, ${0.2 * intensity})`);
            gradient.addColorStop(1, `hsla(${(hue + 240) % 360}, 100%, 50%, ${0.1 * intensity})`);
            
            ctx.fillStyle = gradient;
            ctx.globalCompositeOperation = 'overlay';
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
            
            // Add disco ball reflections
            for (let i = 0; i < 30 * intensity; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const size = 2 + Math.random() * 8;
                
                ctx.fillStyle = `hsla(${Math.random() * 360}, 100%, 70%, 0.8)`;
                ctx.fillRect(x, y, size, size);
            }
        }

        function applyNeonEffect(ctx, width, height, intensity) {
            // Apply neon glow to edges
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Boost saturation and brightness
                const max = Math.max(r, g, b);
                if (max > 150) {
                    data[i] = Math.min(255, r + 100 * intensity);
                    data[i + 1] = Math.min(255, g + 100 * intensity);
                    data[i + 2] = Math.min(255, b + 100 * intensity);
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Add neon border
            ctx.strokeStyle = `hsl(${Date.now() / 50 % 360}, 100%, 70%)`;
            ctx.lineWidth = 5 * intensity;
            ctx.strokeRect(10, 10, width - 20, height - 20);
        }

        function applyPixelEffect(ctx, width, height, intensity) {
            const pixelSize = Math.max(1, Math.floor(20 * (1 - intensity) + 5));
            
            // Create temporary canvas for pixelation
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = Math.floor(width / pixelSize);
            tempCanvas.height = Math.floor(height / pixelSize);
            
            // Draw scaled down version
            tempCtx.drawImage(ctx.canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            // Draw scaled up (pixelated)
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(tempCanvas, 0, 0, tempCanvas.width, tempCanvas.height, 0, 0, width, height);
            ctx.imageSmoothingEnabled = true;
            
            // Add scanlines for retro effect
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            for (let y = 0; y < height; y += 2) {
                ctx.fillRect(0, y, width, 1);
            }
        }

        function applyComicEffect(ctx, width, height, intensity) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Posterize effect
                const levels = 4;
                data[i] = Math.floor(data[i] / 64) * 64;     // Red
                data[i + 1] = Math.floor(data[i + 1] / 64) * 64; // Green
                data[i + 2] = Math.floor(data[i + 2] / 64) * 64; // Blue
                
                // Boost contrast
                data[i] = data[i] < 128 ? data[i] * 0.7 : Math.min(255, data[i] * 1.3);
                data[i + 1] = data[i + 1] < 128 ? data[i + 1] * 0.7 : Math.min(255, data[i + 1] * 1.3);
                data[i + 2] = data[i + 2] < 128 ? data[i + 2] * 0.7 : Math.min(255, data[i + 2] * 1.3);
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Add comic dots pattern
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            for (let x = 0; x < width; x += 10) {
                for (let y = 0; y < height; y += 10) {
                    if ((x + y) % 20 === 0) {
                        ctx.beginPath();
                        ctx.arc(x, y, 1 * intensity, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
        }

        function applyVintageEffect(ctx, width, height, intensity) {
            // Apply sepia tone
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Sepia formula
                data[i] = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));
                data[i + 1] = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));
                data[i + 2] = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));
                
                // Add fade effect
                const fade = 20 * intensity;
                data[i] = Math.max(0, data[i] - fade);
                data[i + 1] = Math.max(0, data[i + 1] - fade);
                data[i + 2] = Math.max(0, data[i + 2] - fade);
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Add vignette
            const gradient = ctx.createRadialGradient(
                width / 2, height / 2, 0,
                width / 2, height / 2, Math.max(width, height) / 2
            );
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
            gradient.addColorStop(1, `rgba(139, 69, 19, ${0.3 * intensity})`); // Brown vignette
            
            ctx.fillStyle = gradient;
            ctx.globalCompositeOperation = 'multiply';
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
            
            // Add film grain
            const grainData = ctx.createImageData(width, height);
            const grain = grainData.data;
            
            for (let i = 0; i < grain.length; i += 4) {
                const value = Math.random() * 50 * intensity;
                grain[i] = value;
                grain[i + 1] = value;
                grain[i + 2] = value;
                grain[i + 3] = 30 * intensity;
            }
            
            const grainCanvas = document.createElement('canvas');
            const grainCtx = grainCanvas.getContext('2d');
            grainCanvas.width = width;
            grainCanvas.height = height;
            grainCtx.putImageData(grainData, 0, 0);
            
            ctx.globalAlpha = 0.3 * intensity;
            ctx.drawImage(grainCanvas, 0, 0);
            ctx.globalAlpha = 1;
        }

        function applyMirrorEffect(ctx, width, height, intensity) {
            // Create mirrored effect
            const halfWidth = width / 2;
            
            // Copy left half to right half (mirrored)
            ctx.save();
            ctx.translate(width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(ctx.canvas, 0, 0, halfWidth, height, 0, 0, halfWidth, height);
            ctx.restore();
            
            // Add mirror crack effect
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2 * intensity;
            
            for (let i = 0; i < 5; i++) {
                const startX = halfWidth + Math.random() * 20 - 10;
                const startY = Math.random() * height;
                const length = 20 + Math.random() * 50;
                
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                for (let j = 0; j < 5; j++) {
                    ctx.lineTo(
                        startX + (j + 1) * 10,
                        startY + Math.random() * 20 - 10
                    );
                }
                ctx.stroke();
            }
        }

        function applyHeartEffect(ctx, width, height, intensity) {
            // Draw floating hearts
            const time = Date.now() / 1000;
            
            for (let i = 0; i < 15 * intensity; i++) {
                const x = (width * 0.3) + (Math.sin(time + i) * width * 0.4);
                const y = (time * 50 + i * 40) % height;
                const size = 15 + Math.sin(time * 2 + i) * 10;
                
                // Draw heart shape
                ctx.fillStyle = `rgba(255, ${100 + i * 10}, ${150 + i * 10}, 0.7)`;
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(Math.sin(time + i) * 0.2);
                
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.bezierCurveTo(-size/2, -size/2, -size, size/3, 0, size);
                ctx.bezierCurveTo(size, size/3, size/2, -size/2, 0, 0);
                ctx.fill();
                
                ctx.restore();
            }
            
            // Add heart glow overlay
            const gradient = ctx.createRadialGradient(
                width / 2, height / 2, 0,
                width / 2, height / 2, Math.max(width, height) / 2
            );
            gradient.addColorStop(0, 'rgba(255, 182, 193, 0)');
            gradient.addColorStop(1, `rgba(255, 105, 180, ${0.2 * intensity})`);
            
            ctx.fillStyle = gradient;
            ctx.globalCompositeOperation = 'screen';
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
        }

        // Aspect ratio handling (keep as is)
        function initAspectRatioControls() {
            ratioButtons.forEach(button => {
                button.addEventListener('click', () => {
                    ratioButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentAspectRatio = button.dataset.ratio;
                    
                    const cameraContainer = document.querySelector('.camera-container');
                    switch(currentAspectRatio) {
                        case '1:1':
                            cameraContainer.style.aspectRatio = '1/1';
                            break;
                        case '3:4':
                            cameraContainer.style.aspectRatio = '3/4';
                            break;
                        case '9:16':
                            cameraContainer.style.aspectRatio = '9/16';
                            break;
                    }
                });
            });
        }

        // Capture photo (updated to use current live filter)
        captureBtn.addEventListener('click', async () => {
            if (!currentStream) {
                alert('Kamera belum diinisialisasi. Silakan refresh halaman.');
                return;
            }
            
            // Trigger flash effect
            triggerFlashEffect();
            
            // Create temporary canvas for capture
            const tempCanvas = document.createElement('canvas');
            const tempContext = tempCanvas.getContext('2d');
            
            // Set canvas size based on video dimensions
            tempCanvas.width = videoElement.videoWidth;
            tempCanvas.height = videoElement.videoHeight;
            
            // Draw current video frame to canvas (mirrored)
            tempContext.translate(tempCanvas.width, 0);
            tempContext.scale(-1, 1);
            tempContext.drawImage(videoElement, 0, 0, tempCanvas.width, tempCanvas.height);
            tempContext.setTransform(1, 0, 0, 1, 0, 0);
            
            // Apply active effects to captured image
            const intensity = parseInt(intensitySlider.value) / 100;
            activeEffects.forEach(effectId => {
                const effect = effects.find(e => e.id === effectId);
                if (effect && effect.applyEffect) {
                    effect.applyEffect(tempContext, tempCanvas.width, tempCanvas.height, intensity);
                }
            });
            
            // Store captured image data
            capturedImage = tempCanvas;
            
            // Show preview panel
            previewPanel.classList.add('active');
            
            // Render preview
            renderPreview();
        });

        // Trigger flash animation
        function triggerFlashEffect() {
            flashOverlay.classList.add('active');
            captureBtn.classList.add('flash');
            
            setTimeout(() => {
                flashOverlay.classList.remove('active');
                captureBtn.classList.remove('flash');
            }, 300);
        }

        // Render preview (keep as is)
        function renderPreview() {
            if (!capturedImage || !previewContext) return;
            
            // Clear preview canvas
            previewCanvas.width = capturedImage.width;
            previewCanvas.height = capturedImage.height;
            
            // Apply aspect ratio crop
            let cropWidth = capturedImage.width;
            let cropHeight = capturedImage.height;
            let offsetX = 0;
            let offsetY = 0;
            
            switch(currentAspectRatio) {
                case '1:1':
                    const size = Math.min(capturedImage.width, capturedImage.height);
                    cropWidth = size;
                    cropHeight = size;
                    offsetX = (capturedImage.width - size) / 2;
                    offsetY = (capturedImage.height - size) / 2;
                    break;
                    
                case '3:4':
                    cropHeight = capturedImage.width * (4/3);
                    if (cropHeight > capturedImage.height) {
                        cropHeight = capturedImage.height;
                        cropWidth = capturedImage.height * (3/4);
                        offsetX = (capturedImage.width - cropWidth) / 2;
                    } else {
                        offsetY = (capturedImage.height - cropHeight) / 2;
                    }
                    break;
                    
                case '9:16':
                    cropHeight = capturedImage.width * (16/9);
                    if (cropHeight > capturedImage.height) {
                        cropHeight = capturedImage.height;
                        cropWidth = capturedImage.height * (9/16);
                        offsetX = (capturedImage.width - cropWidth) / 2;
                    } else {
                        offsetY = (capturedImage.height - cropHeight) / 2;
                    }
                    break;
            }
            
            // Draw captured image with crop
            previewContext.drawImage(
                capturedImage, 
                offsetX, offsetY, cropWidth, cropHeight,
                0, 0, previewCanvas.width, previewCanvas.height
            );
            
            // Apply watermark
            applyWatermark(previewContext, previewCanvas.width, previewCanvas.height);
        }

        function applyWatermark(ctx, width, height) {
            ctx.font = 'italic 300 24px Inter, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'bottom';
            
            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
            ctx.shadowBlur = 4;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            ctx.fillText('design by finzx', width - 20, height - 20);
            
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
        }

        // Download photo (keep as is)
        downloadBtn.addEventListener('click', () => {
            if (!capturedImage) return;
            
            const outputCanvas = document.createElement('canvas');
            const outputCtx = outputCanvas.getContext('2d');
            
            let outputWidth, outputHeight;
            
            switch(currentAspectRatio) {
                case '1:1':
                    outputWidth = outputHeight = 2000;
                    break;
                case '3:4':
                    outputWidth = 1500;
                    outputHeight = 2000;
                    break;
                case '9:16':
                    outputWidth = 1125;
                    outputHeight = 2000;
                    break;
            }
            
            outputCanvas.width = outputWidth;
            outputCanvas.height = outputHeight;
            
            outputCtx.imageSmoothingEnabled = true;
            outputCtx.imageSmoothingQuality = 'high';
            outputCtx.drawImage(previewCanvas, 0, 0, outputWidth, outputHeight);
            
            outputCtx.font = 'italic 300 36px Inter, sans-serif';
            outputCtx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            outputCtx.textAlign = 'right';
            outputCtx.textBaseline = 'bottom';
            outputCtx.fillText('design by finzx', outputWidth - 30, outputHeight - 30);
            
            const link = document.createElement('a');
            link.download = `finzx_photobooth_${new Date().getTime()}.jpg`;
            link.href = outputCanvas.toDataURL('image/jpeg', 0.95);
            link.click();
            
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<span>‚úÖ</span> Terdownload!';
            downloadBtn.style.background = 'linear-gradient(135deg, #00ff88, #00cc66)';
            
            setTimeout(() => {
                downloadBtn.innerHTML = originalText;
                downloadBtn.style.background = 'linear-gradient(135deg, var(--accent-pastel), var(--accent-purple))';
            }, 2000);
        });

        // Retake photo
        retakeBtn.addEventListener('click', () => {
            previewPanel.classList.remove('active');
            capturedImage = null;
        });

        // Intensity slider update
        intensitySlider.addEventListener('input', () => {
            intensityValue.textContent = `${intensitySlider.value}%`;
            // Live preview automatically updates through animation loop
        });

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            initCamera();
            createEffectButtons();
            initAspectRatioControls();
            
            intensityValue.textContent = `${intensitySlider.value}%`;
            
            window.addEventListener('resize', () => {
                if (capturedImage) {
                    renderPreview();
                }
            });
        });

        // Clean up
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        });
    </script>
</body>
</html>
