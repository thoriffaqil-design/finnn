<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinzX Photobooth | Premium Camera Experience</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Color Palette */
            --bg-dark: #0a0a12;
            --bg-panel: #131320;
            --bg-card: #1a1a2e;
            --accent-neon: #00ffea;
            --accent-pastel: #ff6bcb;
            --accent-cyan: #00f7ff;
            --accent-purple: #9d4edd;
            --text-primary: #ffffff;
            --text-secondary: #b0b0d0;
            --text-muted: #6a6a8a;
            
            /* Effects Colors */
            --vintage-brown: #8b7355;
            --cinematic-blue: #1e3a5f;
            --soft-glow: rgba(255, 255, 200, 0.3);
            --neon-glow: rgba(0, 255, 234, 0.3);
            --light-leak-orange: rgba(255, 107, 203, 0.2);
            --light-leak-blue: rgba(0, 247, 255, 0.2);
            
            /* Typography */
            --font-main: 'Inter', sans-serif;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 50%;
            
            /* Shadows */
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.3);
            --shadow-neon: 0 0 20px rgba(0, 255, 234, 0.4);
            --shadow-pastel: 0 0 20px rgba(255, 107, 203, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(157, 78, 221, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 255, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 107, 203, 0.05) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-neon), var(--accent-pastel));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo-icon {
            font-size: 2.2rem;
        }

        .camera-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 16px;
            border-radius: var(--radius-full);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Camera Area */
        .camera-section {
            background: var(--bg-panel);
            border-radius: var(--radius-xl);
            padding: 30px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .camera-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-neon), var(--accent-pastel));
        }

        .camera-container {
            position: relative;
            width: 100%;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3;
            margin-bottom: 25px;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            display: block;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .overlay-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            opacity: 0.3;
        }

        .grid-line {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .focus-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 2px solid var(--accent-neon);
            border-radius: 50%;
            opacity: 0.5;
            animation: focusPulse 3s infinite;
        }

        @keyframes focusPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
        }

        /* Capture Button */
        .capture-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .capture-btn {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-neon), var(--accent-cyan));
            border: none;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 255, 234, 0.3);
        }

        .capture-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 255, 234, 0.5);
        }

        .capture-btn:active {
            transform: scale(0.95);
        }

        .capture-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .capture-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 50%;
            opacity: 0.7;
            transition: transform 0.3s;
        }

        .capture-btn.flash::after {
            transform: translate(-50%, -50%) scale(1.5);
            opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
        }

        /* Aspect Ratio Selector */
        .ratio-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .ratio-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: 10px 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ratio-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .ratio-btn.active {
            background: var(--accent-purple);
            color: white;
            border-color: var(--accent-purple);
            box-shadow: 0 0 15px rgba(157, 78, 221, 0.5);
        }

        /* Sidebar Controls */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .controls-panel {
            background: var(--bg-panel);
            border-radius: var(--radius-xl);
            padding: 25px;
            box-shadow: var(--shadow-lg);
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Effect Controls */
        .effects-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .effect-item {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .effect-item:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .effect-item.active {
            border-color: var(--accent-neon);
            box-shadow: 0 0 20px rgba(0, 255, 234, 0.3);
        }

        .effect-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .effect-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .effect-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .effect-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-neon);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .effect-item.active .effect-badge {
            opacity: 1;
        }

        /* Intensity Slider */
        .slider-container {
            margin-top: 10px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-neon);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 234, 0.5);
        }

        /* Preview Panel */
        .preview-panel {
            background: var(--bg-panel);
            border-radius: var(--radius-xl);
            padding: 25px;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .preview-panel.active {
            display: block;
        }

        .preview-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .preview-container {
            width: 100%;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: #000;
            margin-bottom: 20px;
            aspect-ratio: 4/3;
            position: relative;
        }

        #previewCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .preview-watermark {
            position: absolute;
            bottom: 15px;
            right: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 300;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: var(--radius-sm);
        }

        .preview-controls {
            display: flex;
            gap: 15px;
        }

        .preview-btn {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .download-btn {
            background: linear-gradient(135deg, var(--accent-pastel), var(--accent-purple));
            color: white;
        }

        .retake-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .preview-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        /* Footer */
        .footer {
            grid-column: 1 / -1;
            text-align: center;
            padding-top: 30px;
            margin-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .footer-highlight {
            color: var(--accent-pastel);
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                order: 3;
            }
            
            .camera-section {
                order: 1;
            }
            
            .preview-panel {
                order: 2;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .camera-section, .controls-panel, .preview-panel {
                padding: 20px;
            }
            
            .effects-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }

        @media (max-width: 480px) {
            .effects-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .preview-controls {
                flex-direction: column;
            }
            
            .ratio-selector {
                flex-wrap: wrap;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        /* Animation for flash */
        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
        }

        .flash-overlay.active {
            animation: flash 0.3s;
        }
    </style>
</head>
<body>
    <!-- Flash Effect Overlay -->
    <div class="flash-overlay" id="flashOverlay"></div>
    
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">üì∏</span>
                <span>FinzX Photobooth</span>
            </div>
            <div class="camera-status">
                <span class="status-indicator"></span>
                <span id="cameraStatus">Kamera siap digunakan</span>
            </div>
        </header>
        
        <!-- Main Camera Section -->
        <main class="camera-section">
            <div class="camera-container">
                <video id="videoElement" autoplay playsinline></video>
                <div class="camera-overlay">
                    <div class="overlay-grid">
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                    </div>
                    <div class="focus-center"></div>
                </div>
            </div>
            
            <div class="capture-controls">
                <button class="capture-btn" id="captureBtn" title="Ambil foto"></button>
                
                <div class="ratio-selector">
                    <button class="ratio-btn active" data-ratio="1:1">1:1</button>
                    <button class="ratio-btn" data-ratio="3:4">3:4</button>
                    <button class="ratio-btn" data-ratio="9:16">9:16</button>
                </div>
            </div>
        </main>
        
        <!-- Sidebar Controls -->
        <aside class="sidebar">
            <!-- Effects Panel -->
            <div class="controls-panel">
                <h3 class="panel-title">üé® Efek Visual</h3>
                
                <div class="effects-grid" id="effectsGrid">
                    <!-- Effects will be added by JavaScript -->
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Intensitas Efek</span>
                        <span id="intensityValue">50%</span>
                    </div>
                    <input type="range" min="0" max="100" value="50" class="slider" id="intensitySlider">
                </div>
            </div>
            
            <!-- Preview Panel -->
            <div class="preview-panel" id="previewPanel">
                <h3 class="preview-title">üñºÔ∏è Pratinjau Foto</h3>
                
                <div class="preview-container">
                    <canvas id="previewCanvas"></canvas>
                    <div class="preview-watermark">design by finzx</div>
                </div>
                
                <div class="preview-controls">
                    <button class="preview-btn download-btn" id="downloadBtn">
                        <span>‚¨áÔ∏è</span> Download HD
                    </button>
                    <button class="preview-btn retake-btn" id="retakeBtn">
                        <span>‚Üª</span> Ambil Ulang
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Footer -->
        <footer class="footer">
            <p>¬© 2024 <span class="footer-highlight">FinzX Photobooth</span> ‚Äî Premium Camera Experience</p>
            <p>Gunakan browser terbaru untuk pengalaman terbaik. Semua foto dilindungi watermark eksklusif.</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const videoElement = document.getElementById('videoElement');
        const captureBtn = document.getElementById('captureBtn');
        const flashOverlay = document.getElementById('flashOverlay');
        const previewPanel = document.getElementById('previewPanel');
        const previewCanvas = document.getElementById('previewCanvas');
        const downloadBtn = document.getElementById('downloadBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const intensitySlider = document.getElementById('intensitySlider');
        const intensityValue = document.getElementById('intensityValue');
        const cameraStatus = document.getElementById('cameraStatus');
        const effectsGrid = document.getElementById('effectsGrid');
        const ratioButtons = document.querySelectorAll('.ratio-btn');
        
        // State Variables
        let currentStream = null;
        let activeEffects = new Set();
        let currentAspectRatio = '1:1';
        let capturedImage = null;
        let previewContext = null;
        
        // Define available effects
        const effects = [
            {
                id: 'vintage',
                name: 'Vintage',
                description: 'Efek foto klasik tahun 70-an',
                icon: 'üï∞Ô∏è',
                applyEffect: applyVintageEffect
            },
            {
                id: 'blackwhite',
                name: 'Black & White',
                description: 'Foto hitam putih elegan',
                icon: '‚ö´',
                applyEffect: applyBlackWhiteEffect
            },
            {
                id: 'cinematic',
                name: 'Cinematic',
                description: 'Warna film Hollywood',
                icon: 'üé¨',
                applyEffect: applyCinematicEffect
            },
            {
                id: 'softglow',
                name: 'Soft Glow',
                description: 'Cahaya lembut romantis',
                icon: '‚ú®',
                applyEffect: applySoftGlowEffect
            },
            {
                id: 'blur',
                name: 'Blur Background',
                description: 'Fokus pada subjek utama',
                icon: 'üå´Ô∏è',
                applyEffect: applyBlurEffect
            },
            {
                id: 'neon',
                name: 'Neon Glow',
                description: 'Cahaya neon futuristik',
                icon: 'üîÆ',
                applyEffect: applyNeonEffect
            },
            {
                id: 'mirror',
                name: 'Mirror',
                description: 'Efek cermin simetris',
                icon: 'ü™û',
                applyEffect: applyMirrorEffect
            },
            {
                id: 'grain',
                name: 'Film Grain',
                description: 'Tekstur film analog',
                icon: 'üìΩÔ∏è',
                applyEffect: applyGrainEffect
            },
            {
                id: 'dreamy',
                name: 'Dreamy',
                description: 'Efek mimpi pastel lembut',
                icon: 'üåå',
                applyEffect: applyDreamyEffect
            },
            {
                id: 'pastel',
                name: 'Pastel',
                description: 'Warna pastel cerah',
                icon: 'üé®',
                applyEffect: applyPastelEffect
            },
            {
                id: 'lightleak',
                name: 'Light Leak',
                description: 'Kebocoran cahaya artistik',
                icon: 'üîÜ',
                applyEffect: applyLightLeakEffect
            },
            {
                id: 'dramatic',
                name: 'Dramatic',
                description: 'Kontras tinggi dramatis',
                icon: 'üé≠',
                applyEffect: applyDramaticEffect
            }
        ];

        // Initialize camera
        async function initCamera() {
            try {
                cameraStatus.textContent = 'Mengakses kamera...';
                
                const constraints = {
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        facingMode: 'user'
                    },
                    audio: false
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = currentStream;
                
                cameraStatus.textContent = 'Kamera aktif ‚Ä¢ Resolusi HD';
                
                // Initialize preview canvas context
                previewContext = previewCanvas.getContext('2d');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                cameraStatus.textContent = 'Kamera tidak tersedia';
                cameraStatus.style.color = '#ff4444';
                
                // Show error message
                alert('Tidak dapat mengakses kamera. Pastikan kamera terhubung dan izin diberikan.');
            }
        }

        // Create effect buttons
        function createEffectButtons() {
            effects.forEach(effect => {
                const effectElement = document.createElement('div');
                effectElement.className = 'effect-item';
                effectElement.dataset.id = effect.id;
                effectElement.innerHTML = `
                    <div class="effect-icon">${effect.icon}</div>
                    <div class="effect-name">${effect.name}</div>
                    <div class="effect-desc">${effect.description}</div>
                    <div class="effect-badge"></div>
                `;
                
                effectElement.addEventListener('click', () => {
                    effectElement.classList.toggle('active');
                    
                    if (effectElement.classList.contains('active')) {
                        activeEffects.add(effect.id);
                    } else {
                        activeEffects.delete(effect.id);
                    }
                    
                    // If we have a captured image, update the preview
                    if (capturedImage) {
                        renderPreview();
                    }
                });
                
                effectsGrid.appendChild(effectElement);
            });
        }

        // Aspect ratio handling
        function initAspectRatioControls() {
            ratioButtons.forEach(button => {
                button.addEventListener('click', () => {
                    ratioButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentAspectRatio = button.dataset.ratio;
                    
                    // Update camera container aspect ratio
                    const cameraContainer = document.querySelector('.camera-container');
                    switch(currentAspectRatio) {
                        case '1:1':
                            cameraContainer.style.aspectRatio = '1/1';
                            break;
                        case '3:4':
                            cameraContainer.style.aspectRatio = '3/4';
                            break;
                        case '9:16':
                            cameraContainer.style.aspectRatio = '9/16';
                            break;
                    }
                });
            });
        }

        // Capture photo
        captureBtn.addEventListener('click', async () => {
            if (!currentStream) {
                alert('Kamera belum diinisialisasi. Silakan refresh halaman.');
                return;
            }
            
            // Trigger flash effect
            triggerFlashEffect();
            
            // Create temporary canvas for capture
            const tempCanvas = document.createElement('canvas');
            const tempContext = tempCanvas.getContext('2d');
            
            // Set canvas size based on video dimensions
            tempCanvas.width = videoElement.videoWidth;
            tempCanvas.height = videoElement.videoHeight;
            
            // Draw current video frame to canvas (mirrored)
            tempContext.translate(tempCanvas.width, 0);
            tempContext.scale(-1, 1);
            tempContext.drawImage(videoElement, 0, 0, tempCanvas.width, tempCanvas.height);
            tempContext.setTransform(1, 0, 0, 1, 0, 0);
            
            // Store captured image data
            capturedImage = tempCanvas;
            
            // Show preview panel
            previewPanel.classList.add('active');
            
            // Render preview with effects
            renderPreview();
        });

        // Trigger flash animation
        function triggerFlashEffect() {
            flashOverlay.classList.add('active');
            captureBtn.classList.add('flash');
            
            setTimeout(() => {
                flashOverlay.classList.remove('active');
                captureBtn.classList.remove('flash');
            }, 300);
        }

        // Render preview with effects
        function renderPreview() {
            if (!capturedImage || !previewContext) return;
            
            // Clear preview canvas
            previewCanvas.width = capturedImage.width;
            previewCanvas.height = capturedImage.height;
            
            // Apply aspect ratio crop
            let cropWidth = capturedImage.width;
            let cropHeight = capturedImage.height;
            let offsetX = 0;
            let offsetY = 0;
            
            switch(currentAspectRatio) {
                case '1:1':
                    const size = Math.min(capturedImage.width, capturedImage.height);
                    cropWidth = size;
                    cropHeight = size;
                    offsetX = (capturedImage.width - size) / 2;
                    offsetY = (capturedImage.height - size) / 2;
                    break;
                    
                case '3:4':
                    cropHeight = capturedImage.width * (4/3);
                    if (cropHeight > capturedImage.height) {
                        cropHeight = capturedImage.height;
                        cropWidth = capturedImage.height * (3/4);
                        offsetX = (capturedImage.width - cropWidth) / 2;
                    } else {
                        offsetY = (capturedImage.height - cropHeight) / 2;
                    }
                    break;
                    
                case '9:16':
                    cropHeight = capturedImage.width * (16/9);
                    if (cropHeight > capturedImage.height) {
                        cropHeight = capturedImage.height;
                        cropWidth = capturedImage.height * (9/16);
                        offsetX = (capturedImage.width - cropWidth) / 2;
                    } else {
                        offsetY = (capturedImage.height - cropHeight) / 2;
                    }
                    break;
            }
            
            // Draw captured image with crop
            previewContext.drawImage(
                capturedImage, 
                offsetX, offsetY, cropWidth, cropHeight,
                0, 0, previewCanvas.width, previewCanvas.height
            );
            
            // Apply active effects
            const intensity = parseInt(intensitySlider.value) / 100;
            
            activeEffects.forEach(effectId => {
                const effect = effects.find(e => e.id === effectId);
                if (effect && effect.applyEffect) {
                    effect.applyEffect(previewContext, previewCanvas.width, previewCanvas.height, intensity);
                }
            });
            
            // Apply watermark
            applyWatermark(previewContext, previewCanvas.width, previewCanvas.height);
        }

        // Effect Functions
        function applyVintageEffect(ctx, width, height, intensity) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Add brown/yellow tint
                data[i] = Math.min(255, data[i] + 20 * intensity);     // Red
                data[i + 1] = data[i + 1] * (1 - 0.1 * intensity);     // Green
                data[i + 2] = Math.max(0, data[i + 2] - 10 * intensity); // Blue
                
                // Add slight fade
                const fade = 20 * intensity;
                data[i] = Math.min(255, data[i] + fade);
                data[i + 1] = Math.min(255, data[i + 1] + fade);
                data[i + 2] = Math.min(255, data[i + 2] + fade);
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Add vignette
            const gradient = ctx.createRadialGradient(
                width / 2, height / 2, 0,
                width / 2, height / 2, Math.max(width, height) / 2
            );
            gradient.addColorStop(0, `rgba(0, 0, 0, 0)`);
            gradient.addColorStop(1, `rgba(139, 115, 85, ${0.3 * intensity})`);
            
            ctx.fillStyle = gradient;
            ctx.globalCompositeOperation = 'multiply';
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
        }

        function applyBlackWhiteEffect(ctx, width, height, intensity) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                const gray = avg * intensity + (data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11) * (1 - intensity);
                
                data[i] = gray;     // Red
                data[i + 1] = gray; // Green
                data[i + 2] = gray; // Blue
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        function applyCinematicEffect(ctx, width, height, intensity) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Boost blues, reduce greens for cinematic look
                data[i] = data[i] * (1 - 0.1 * intensity);     // Red
                data[i + 1] = data[i + 1] * (1 - 0.15 * intensity); // Green
                data[i + 2] = Math.min(255, data[i + 2] * (1 + 0.1 * intensity)); // Blue
                
                // Increase contrast
                const contrast = 1.1 * intensity;
                data[i] = ((data[i] - 128) * contrast) + 128;
                data[i + 1] = ((data[i + 1] - 128) * contrast) + 128;
                data[i + 2] = ((data[i + 2] - 128) * contrast) + 128;
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Add blue tint overlay
            ctx.fillStyle = `rgba(30, 58, 95, ${0.2 * intensity})`;
            ctx.globalCompositeOperation = 'overlay';
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
        }

        function applySoftGlowEffect(ctx, width, height, intensity) {
            // Create a blurred copy
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            
            tempCtx.drawImage(ctx.canvas, 0, 0);
            
            // Apply blur
            tempCtx.filter = `blur(${10 * intensity}px)`;
            tempCtx.drawImage(tempCanvas, 0, 0);
            tempCtx.filter = 'none';
            
            // Composite with original
            ctx.globalAlpha = 0.5 * intensity;
            ctx.drawImage(tempCanvas, 0, 0);
            ctx.globalAlpha = 1;
            
            // Add soft light overlay
            ctx.fillStyle = `rgba(255, 255, 200, ${0.2 * intensity})`;
            ctx.globalCompositeOperation = 'soft-light';
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
        }

        function applyBlurEffect(ctx, width, height, intensity) {
            // Create a copy of the image
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            tempCtx.drawImage(ctx.canvas, 0, 0);
            
            // Apply strong blur
            tempCtx.filter = `blur(${20 * intensity}px)`;
            tempCtx.drawImage(tempCanvas, 0, 0);
            tempCtx.filter = 'none';
            
            // Create a mask for the center (keep it sharp)
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.3;
            
            // Draw blurred version
            ctx.drawImage(tempCanvas, 0, 0);
            
            // Draw sharp center
            ctx.save();
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.clip();
            ctx.drawImage(ctx.canvas, 0, 0, width, height);
            ctx.restore();
        }

        function applyNeonEffect(ctx, width, height, intensity) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Boost saturation
                const max = Math.max(data[i], data[i + 1], data[i + 2]);
                if (max === data[i]) {
                    data[i] = Math.min(255, data[i] * (1 + 0.5 * intensity)); // Red
                } else if (max === data[i + 1]) {
                    data[i + 1] = Math.min(255, data[i + 1] * (1 + 0.5 * intensity)); // Green
                } else {
                    data[i + 2] = Math.min(255, data[i + 2] * (1 + 0.5 * intensity)); // Blue
                }
                
                // Add glow effect by increasing brightness
                const boost = 30 * intensity;
                data[i] = Math.min(255, data[i] + boost);
                data[i + 1] = Math.min(255, data[i + 1] + boost);
                data[i + 2] = Math.min(255, data[i + 2] + boost);
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Add neon overlay
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, `rgba(0, 255, 234, ${0.2 * intensity})`);
            gradient.addColorStop(1, `rgba(255, 107, 203, ${0.2 * intensity})`);
            
            ctx.fillStyle = gradient;
            ctx.globalCompositeOperation = 'overlay';
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
        }

        function applyMirrorEffect(ctx, width, height, intensity) {
            // Create a mirrored copy
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            
            // Draw original
            tempCtx.drawImage(ctx.canvas, 0, 0);
            
            // Clear the right half
            ctx.clearRect(width / 2, 0, width / 2, height);
            
            // Draw mirrored left half to right side
            ctx.save();
            ctx.translate(width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(tempCanvas, 0, 0, width / 2, height, 0, 0, width / 2, height);
            ctx.restore();
        }

        function applyGrainEffect(ctx, width, height, intensity) {
            const grainCanvas = document.createElement('canvas');
            const grainCtx = grainCanvas.getContext('2d');
            grainCanvas.width = width;
            grainCanvas.height = height;
            
            // Create grain texture
            const grainData = grainCtx.createImageData(width, height);
            const grain = grainData.data;
            
            for (let i = 0; i < grain.length; i += 4) {
                const value = Math.random() * 255 * intensity;
                grain[i] = value;     // Red
                grain[i + 1] = value; // Green
                grain[i + 2] = value; // Blue
                grain[i + 3] = 50 * intensity; // Alpha
            }
            
            grainCtx.putImageData(grainData, 0, 0);
            
            // Apply grain overlay
            ctx.globalAlpha = 0.7 * intensity;
            ctx.drawImage(grainCanvas, 0, 0);
            ctx.globalAlpha = 1;
        }

        function applyDreamyEffect(ctx, width, height, intensity) {
            // Apply soft blur first
            applySoftGlowEffect(ctx, width, height, intensity * 0.7);
            
            // Add pastel color overlay
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, `rgba(255, 182, 193, ${0.2 * intensity})`); // Light pink
            gradient.addColorStop(0.5, `rgba(173, 216, 230, ${0.2 * intensity})`); // Light blue
            gradient.addColorStop(1, `rgba(221, 160, 221, ${0.2 * intensity})`); // Plum
            
            ctx.fillStyle = gradient;
            ctx.globalCompositeOperation = 'soft-light';
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
            
            // Reduce contrast for dreamy look
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Lighten shadows
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                if (avg < 128) {
                    const lift = (128 - avg) * 0.3 * intensity;
                    data[i] = Math.min(255, data[i] + lift);
                    data[i + 1] = Math.min(255, data[i + 1] + lift);
                    data[i + 2] = Math.min(255, data[i + 2] + lift);
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        function applyPastelEffect(ctx, width, height, intensity) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Reduce saturation and increase brightness
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                
                // Mix with white for pastel effect
                data[i] = avg * intensity + data[i] * (1 - intensity);
                data[i + 1] = avg * intensity + data[i + 1] * (1 - intensity);
                data[i + 2] = avg * intensity + data[i + 2] * (1 - intensity);
                
                // Increase brightness
                const brighten = 30 * intensity;
                data[i] = Math.min(255, data[i] + brighten);
                data[i + 1] = Math.min(255, data[i + 1] + brighten);
                data[i + 2] = Math.min(255, data[i + 2] + brighten);
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        function applyLightLeakEffect(ctx, width, height, intensity) {
            // Create light leak gradient
            const gradient1 = ctx.createRadialGradient(
                width * 0.8, height * 0.2, 0,
                width * 0.8, height * 0.2, width * 0.5
            );
            gradient1.addColorStop(0, `rgba(255, 107, 203, ${0.8 * intensity})`);
            gradient1.addColorStop(1, `rgba(255, 107, 203, 0)`);
            
            const gradient2 = ctx.createRadialGradient(
                width * 0.2, height * 0.8, 0,
                width * 0.2, height * 0.8, width * 0.4
            );
            gradient2.addColorStop(0, `rgba(0, 247, 255, ${0.6 * intensity})`);
            gradient2.addColorStop(1, `rgba(0, 247, 255, 0)`);
            
            // Apply gradients
            ctx.fillStyle = gradient1;
            ctx.globalCompositeOperation = 'screen';
            ctx.fillRect(0, 0, width, height);
            
            ctx.fillStyle = gradient2;
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
        }

        function applyDramaticEffect(ctx, width, height, intensity) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Increase contrast dramatically
                const contrast = 1.0 + 1.5 * intensity;
                data[i] = ((data[i] - 128) * contrast) + 128;
                data[i + 1] = ((data[i + 1] - 128) * contrast) + 128;
                data[i + 2] = ((data[i + 2] - 128) * contrast) + 128;
                
                // Darken shadows
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                if (avg < 128) {
                    const darken = (128 - avg) * 0.5 * intensity;
                    data[i] = Math.max(0, data[i] - darken);
                    data[i + 1] = Math.max(0, data[i + 1] - darken);
                    data[i + 2] = Math.max(0, data[i + 2] - darken);
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Add vignette
            const gradient = ctx.createRadialGradient(
                width / 2, height / 2, 0,
                width / 2, height / 2, Math.max(width, height) / 2
            );
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
            gradient.addColorStop(1, `rgba(0, 0, 0, ${0.5 * intensity})`);
            
            ctx.fillStyle = gradient;
            ctx.globalCompositeOperation = 'multiply';
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over';
        }

        function applyWatermark(ctx, width, height) {
            ctx.font = 'italic 300 24px Inter, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'bottom';
            
            // Add shadow for better visibility
            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
            ctx.shadowBlur = 4;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            ctx.fillText('design by finzx', width - 20, height - 20);
            
            // Reset shadow
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
        }

        // Download photo
        downloadBtn.addEventListener('click', () => {
            if (!capturedImage) return;
            
            // Create a temporary canvas for final output
            const outputCanvas = document.createElement('canvas');
            const outputCtx = outputCanvas.getContext('2d');
            
            // Set output size (high quality)
            let outputWidth, outputHeight;
            
            switch(currentAspectRatio) {
                case '1:1':
                    outputWidth = outputHeight = 2000;
                    break;
                case '3:4':
                    outputWidth = 1500;
                    outputHeight = 2000;
                    break;
                case '9:16':
                    outputWidth = 1125;
                    outputHeight = 2000;
                    break;
            }
            
            outputCanvas.width = outputWidth;
            outputCanvas.height = outputHeight;
            
            // Draw preview to output canvas with high quality scaling
            outputCtx.imageSmoothingEnabled = true;
            outputCtx.imageSmoothingQuality = 'high';
            outputCtx.drawImage(previewCanvas, 0, 0, outputWidth, outputHeight);
            
            // Add watermark to output
            outputCtx.font = 'italic 300 36px Inter, sans-serif';
            outputCtx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            outputCtx.textAlign = 'right';
            outputCtx.textBaseline = 'bottom';
            outputCtx.fillText('design by finzx', outputWidth - 30, outputHeight - 30);
            
            // Create download link
            const link = document.createElement('a');
            link.download = `finzx_photobooth_${new Date().getTime()}.jpg`;
            link.href = outputCanvas.toDataURL('image/jpeg', 0.95);
            link.click();
            
            // Show feedback
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<span>‚úÖ</span> Terdownload!';
            downloadBtn.style.background = 'linear-gradient(135deg, #00ff88, #00cc66)';
            
            setTimeout(() => {
                downloadBtn.innerHTML = originalText;
                downloadBtn.style.background = 'linear-gradient(135deg, var(--accent-pastel), var(--accent-purple))';
            }, 2000);
        });

        // Retake photo
        retakeBtn.addEventListener('click', () => {
            previewPanel.classList.remove('active');
            capturedImage = null;
        });

        // Intensity slider update
        intensitySlider.addEventListener('input', () => {
            intensityValue.textContent = `${intensitySlider.value}%`;
            if (capturedImage) {
                renderPreview();
            }
        });

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            initCamera();
            createEffectButtons();
            initAspectRatioControls();
            
            // Update intensity display
            intensityValue.textContent = `${intensitySlider.value}%`;
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (capturedImage) {
                    renderPreview();
                }
            });
        });

        // Clean up camera stream on page unload
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>